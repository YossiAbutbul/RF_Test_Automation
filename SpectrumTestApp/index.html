<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spectrum Analyzer UI</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background-color: #121212;
      color: #e0e0e0;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    .container { display: flex; width: 100%; }
    .sidebar {
      width: 45%; max-width: 650px; padding: 16px;
      background-color: #1e1e1e; overflow-y: auto;
      border-right: 1px solid #333; display: flex; flex-direction: column; gap: 16px;
    }
    .sidebar h2 { color: #26a69a; }
    .section { background-color: #2a2a2a; padding: 12px; border-radius: 8px; }
    .section h3 { margin-top: 0; font-size: 16px; color: #80cbc4; margin-bottom: 8px; }
    input, select, button {
      width: 100%; padding: 6px; margin-bottom: 8px;
      border-radius: 4px; border: 1px solid #555;
      background-color: #2e2e2e; color: white;
    }
    button { background-color: #26a69a; cursor: pointer; }
    button:hover { background-color: #2bbbad; }
    .response-panel {
      flex-grow: 1; padding: 20px; background-color: #181818; overflow-y: auto;
    }
    .response-panel h3 { color: #ffcc80; margin-top: 0; }
    pre {
      background-color: #263238; padding: 15px; color: #c3e88d;
      border-radius: 6px; font-size: 13px; overflow-x: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <h2>Spectrum Analyzer</h2>

      <div class="section">
        <h3>Connection</h3>
        <button onclick="send('/connect')">Connect</button>
        <button onclick="send('/disconnect')">Disconnect</button>
        <button onclick="send('/reset')">Reset</button>
        <button onclick="send('/identify', 'GET')">Identify</button>
      </div>

      <div class="section">
        <h3>Center Frequency</h3>
        <label>Frequency:</label>
        <input type="number" id="freqInput" />
        <label>Units:</label>
        <select id="freqUnits">
          <option value="HZ">Hz</option>
          <option value="KHZ">kHz</option>
          <option value="MHZ">MHz</option>
          <option value="GHZ">GHz</option>
        </select>
        <button onclick="setCenterFreq()">Set Frequency</button>
      </div>

      <div class="section">
        <h3>Span / RBW / VBW</h3>
        <label>Span:</label>
        <input type="number" id="spanValue" />
        <select id="spanUnits">
          <option value="HZ">Hz</option>
          <option value="KHZ">kHz</option>
          <option value="MHZ">MHz</option>
          <option value="GHZ">GHz</option>
        </select>
        <button onclick="updateSpan()">Set Span</button>

        <label>RBW:</label>
        <input type="number" id="rbwValue" />
        <select id="rbwUnits">
          <option value="HZ">Hz</option>
          <option value="KHZ">kHz</option>
          <option value="MHZ">MHz</option>
        </select>
        <button onclick="postValue('/set_rbw', { value: getVal('rbwValue'), units: getVal('rbwUnits') })">Set RBW</button>

        <label>VBW:</label>
        <input type="number" id="vbwValue" />
        <select id="vbwUnits">
          <option value="HZ">Hz</option>
          <option value="KHZ">kHz</option>
          <option value="MHZ">MHz</option>
        </select>
        <button onclick="postValue('/set_vbw', { value: getVal('vbwValue'), units: getVal('vbwUnits') })">Set VBW</button>
      </div>

      <div class="section">
        <h3>Reference Levels</h3>
        <label>Ref Level (dBm):</label>
        <input type="number" id="refLevel" />
        <button onclick="postValue('/set_ref_level', { value: getVal('refLevel') })">Set Ref Level</button>

        <label>Offset (dB):</label>
        <input type="number" id="offset" />
        <button onclick="postValue('/set_ref_level_offset', { value: getVal('offset') })">Set Offset</button>
      </div>

      <div class="section">
        <h3>Detection & Markers</h3>
        <button onclick="send('/set_peak_detector')">Set Peak Detector</button>
        <button onclick="send('/peak_search')">Peak Search</button>
        <button onclick="send('/get_marker_power', 'GET')">Get Marker Power</button>
        <button onclick="send('/get_marker_frequency', 'GET')">Get Marker Frequency</button>
      </div>

      <div class="section">
        <h3>Query Settings</h3>
        <button onclick="send('/get_rbw', 'GET')">Get RBW</button>
        <button onclick="send('/get_vbw', 'GET')">Get VBW</button>
        <button onclick="send('/get_span', 'GET')">Get Span</button>
        <button onclick="send('/get_ref_level', 'GET')">Get Ref Level</button>
        <button onclick="send('/get_ref_level_offset', 'GET')">Get Offset</button>
      </div>

      <div class="section">
        <h3>Screenshots</h3>
        <input type="text" id="screenshotName" value="screenshot" />
        <button onclick="postValue('/take_screenshot', { name: getVal('screenshotName') })">Take Screenshot</button>
        <button onclick="postValue('/download_screenshot')">Download Screenshot</button>
      </div>

      <div class="section">
        <h3>Live Update</h3>
        <button onclick="toggleLive()">Toggle Live Update</button>
      </div>
    </div>

    <div class="response-panel">
      <h3>Real-Time Spectrum Graph</h3>
      <canvas id="spectrumChart" height="200"></canvas>

      <h3>Response Output</h3>
      <pre id="response">{"status": "waiting for action..."}</pre>
    </div>
  </div>

  <script>
  const API = "http://localhost:8000";
  const getVal = id => document.getElementById(id).value;

  let centerFreqHz = 915e6;
  let spanHz = 10e6;
  let tracePoints = 1001;
  let isFetching = false;
  let intervalId = null;
  let refLevel = -50; // fallback ref level (dBm)

  window.onload = () => {
    send('/connect');
  };

  const ctx = document.getElementById('spectrumChart').getContext('2d');
  const spectrumChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Amplitude (dBm)',
        data: [],
        borderColor: '#26a69a',
        backgroundColor: 'rgba(38,166,154,0.1)',
        fill: true,
        pointRadius: 0,
        tension: 0.3
      }]
    },
    options: {
      animation: { duration: 200 },
      scales: {
        x: {
          title: { display: true, text: 'Frequency (Hz)' }
        },
        y: {
          title: { display: true, text: 'Amplitude (dBm)' },
          min: () => refLevel - 20,
          max: () => refLevel + 5
        }
      }
    }
  });

  function showResponse(data) {
    document.getElementById("response").innerText = JSON.stringify(data, null, 2);
  }

  async function send(endpoint, method = "POST") {
    const res = await fetch(`${API}${endpoint}`, { method });
    const data = await res.json();
    showResponse(data);
  }

  async function postValue(endpoint, payload = {}) {
    const res = await fetch(`${API}${endpoint}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    const data = await res.json();
    showResponse(data);
    return data;
  }

  async function setCenterFreq() {
    const freq = parseFloat(getVal("freqInput"));
    const units = getVal("freqUnits");
    let hzValue = freq;
    if (units === "KHZ") hzValue *= 1e3;
    if (units === "MHZ") hzValue *= 1e6;
    if (units === "GHZ") hzValue *= 1e9;
    centerFreqHz = hzValue;
    await postValue("/set_center_freq", { freq: hzValue });
  }

  async function updateSpan() {
    const span = parseFloat(getVal("spanValue"));
    const units = getVal("spanUnits");
    let hzValue = span;
    if (units === "KHZ") hzValue *= 1e3;
    if (units === "MHZ") hzValue *= 1e6;
    if (units === "GHZ") hzValue *= 1e9;
    spanHz = hzValue;
    await postValue("/set_span", { value: hzValue, units: "HZ" });
  }

  async function fetchRefLevel() {
  try {
    const res = await fetch(`${API}/get_ref_level`);
    const json = await res.json();
    if (json.ref_level !== undefined) {
      refLevel = parseFloat(json.ref_level);
      console.log("Reference level set to:", refLevel);

      const divisions = 10;
      const divSize = 10; // typical spectrum scale
      spectrumChart.options.scales.y.max = refLevel;
      spectrumChart.options.scales.y.min = refLevel - (divisions * divSize);
      spectrumChart.update();
    }
  } catch (e) {
    console.warn("Failed to get ref level", e);
  }
}


  async function fetchTraceData() {
    if (isFetching) return;
    isFetching = true;
    try {
      const res = await fetch(`${API}/get_trace_data`);
      const json = await res.json();

      showResponse(json);

      if (json && Array.isArray(json.trace)) {
        const startFreq = centerFreqHz - spanHz / 2;
        const freqLabels = json.trace.map((_, i) =>
          Math.round(startFreq + (i * spanHz) / (json.trace.length - 1))
        );
        spectrumChart.data.labels = freqLabels;
        spectrumChart.data.datasets[0].data = json.trace;
        spectrumChart.update();
      } else {
        console.warn("No usable trace data returned:", json);
      }
    } catch (err) {
      showResponse({ error: err.message });
    } finally {
      isFetching = false;
    }
  }

  async function toggleLive() {
    if (intervalId) {
      clearInterval(intervalId);
      intervalId = null;
      console.log("Live update stopped.");
    } else {
      await fetchRefLevel(); // set ref level before plotting
      intervalId = setInterval(fetchTraceData, 500);
      console.log("Live update started.");
    }
  }
</script>

</body>
</html>
