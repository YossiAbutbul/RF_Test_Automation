name: Mirror to Azure DevOps

on:
  push:
    branches: ["**"]
    tags: ["**"]
  create:
  workflow_dispatch: {}   # allow manual trigger

jobs:
  mirror:
    if: github.event.repository.fork == false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: false   # set to true if you use Git LFS

      - name: Configure Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Build Azure remote URL (with creds)
        id: build
        env:
          AZURE_DEVOPS_USERNAME: ${{ secrets.AZURE_DEVOPS_USERNAME }}
          AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
          AZURE_DEVOPS_URL: ${{ secrets.AZURE_DEVOPS_URL }}
        run: |
          set -euo pipefail
          URL_WITH_CREDS="$(echo "$AZURE_DEVOPS_URL" \
            | sed "s#https://#https://${AZURE_DEVOPS_USERNAME}:${AZURE_DEVOPS_PAT}@#")"
          echo "url=$URL_WITH_CREDS" >> "$GITHUB_OUTPUT"

      - name: Add/Update 'azure' remote
        run: |
          if git remote get-url azure >/dev/null 2>&1; then
            git remote set-url azure "${{ steps.build.outputs.url }}"
          else
            git remote add azure "${{ steps.build.outputs.url }}"
          fi
          # show remotes but redact credentials
          git remote -v | sed 's#https://.*@#https://***:***@#'

      - name: Push branches and tags (safe copy)
        run: |
          git fetch --all --prune
          git push --all azure
          git push --tags azure
