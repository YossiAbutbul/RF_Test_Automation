name: Mirror to Azure DevOps

on:
  push:
    branches: ["**"]
    tags: ["**"]
  delete:
  create:

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: false   # set true if you use Git LFS

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add Azure remote
        env:
          AZURE_DEVOPS_USERNAME: ${{ secrets.AZURE_DEVOPS_USERNAME }}
          AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
          AZURE_DEVOPS_URL: ${{ secrets.AZURE_DEVOPS_URL }}
        run: |
          AZURE_URL_WITH_CREDS=$(echo "$AZURE_DEVOPS_URL" \
            | sed "s#https://#https://${AZURE_DEVOPS_USERNAME}:${AZURE_DEVOPS_PAT}@#")
          git remote add azure "$AZURE_URL_WITH_CREDS"

      - name: Mirror all refs to Azure
        run: |
          git fetch --all --prune
          git push --mirror azure
